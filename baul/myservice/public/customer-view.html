<!DOCTYPE html>
<html lang="es">
<!-- Previous head content remains the same until the style section -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyService PRO - Encuentra tu Proveedor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'inter': ['Inter', 'sans-serif'],
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        },
      },
    }
  </script>

  <style>
    .hidden { display: none; }
    #map {
      height: 400px;
      width: 100%;
      border-radius: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      position: relative;
      z-index: 1;
    }
    .job-icon {
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    .job-icon:hover {
      transform: translateY(-4px);
    }
    .job-icon.selected {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .provider-card {
      transition: all 0.3s ease;
    }
    .provider-card:hover {
      transform: translateY(-2px);
    }
    .scene-transition {
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .provider-details {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      z-index: 1000;
    }
    .provider-details.show {
      transform: translateY(0);
    }
    .review-stars {
      color: #FFD700;
    }
    .chat-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1050;
    }
    .chat-modal.show {
      display: flex;
    }
    .chat-container {
      height: 500px;
      display: flex;
      flex-direction: column;
      background: #f0f0f0;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
      background: white;
      border-radius: 20px 20px 0 0;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    }
    .message {
      max-width: 75%;
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 20px;
      font-size: 0.95rem;
      line-height: 1.3;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      word-wrap: break-word;
      animation: fadeInUp 0.3s ease forwards;
    }
    .message.sent {
      margin-left: auto;
      background-color: #0b93f6;
      color: white;
      border-bottom-right-radius: 5px;
      box-shadow: 0 2px 8px rgba(11,147,246,0.4);
    }
    .message.received {
      margin-right: auto;
      background-color: #e5e5ea;
      color: black;
      border-bottom-left-radius: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-inter">
  <!-- Navbar -->
  <nav class="bg-white shadow-md fixed w-full top-0 z-1000">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <i class="fas fa-handshake text-blue-600 text-2xl mr-2"></i>
          <span class="text-xl font-bold text-gray-900">MyService PRO</span>
        </div>
        <div class="flex items-center space-x-4">
          <button class="text-gray-500 hover:text-gray-700 transition-colors duration-200">
            <i class="fas fa-bell text-xl"></i>
          </button>
          <div class="relative" id="userMenuContainer">
            <button id="userMenuButton" 
                    class="flex items-center space-x-2 text-gray-700 hover:text-gray-900 transition-colors duration-200">
              <img id="navProfilePic" class="h-8 w-8 rounded-full bg-gray-200 object-cover" src="https://ui-avatars.com/api/?name=User&background=0D8ABC&color=fff" alt="Profile">
              <span class="font-medium">Mi Cuenta</span>
              <i class="fas fa-chevron-down text-sm"></i>
            </button>
            <!-- Dropdown Menu -->
            <div id="userMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 hidden z-1000">
              <a href="#perfil" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fas fa-user mr-2"></i> Mi Perfil
              </a>
              <a href="/settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fas fa-cog mr-2"></i> Ajustes de Cuenta
              </a>
              <a href="#notificaciones" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fas fa-bell mr-2"></i> Notificaciones
              </a>
              <a href="#historial" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fas fa-history mr-2"></i> Historial de Servicios
              </a>
              <hr class="my-2 border-gray-200">
              <a href="#ayuda" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fas fa-question-circle mr-2"></i> Ayuda y Soporte
              </a>
              <a href="/auth/logout" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100" id="logoutLink">
                <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="pt-20 pb-8 px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Scene 1: Contact Provider -->
      <section id="scene1" class="scene scene-transition">
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <h2 class="text-2xl font-semibold mb-4 text-gray-900">Encuentra tu Proveedor de Servicios</h2>
          <div id="map" class="mb-6"></div>
          
          <!-- Location Sharing Controls -->
          <div class="bg-white rounded-lg shadow-sm p-4 mb-6 border border-gray-200 relative z-50">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center space-x-2">
                <i class="fas fa-map-marker-alt text-blue-600"></i>
                <h3 class="text-lg font-medium text-gray-900">Compartir Ubicación</h3>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="locationSharingToggle" class="sr-only peer" onchange="toggleGlobalLocationSharing()">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
            <p class="text-sm text-gray-600 mb-4">
              Controla quién puede ver tu ubicación. Solo los proveedores seleccionados podrán verla.
            </p>
            <div id="sharedProvidersContainer" class="space-y-2 hidden">
              <h4 class="font-medium text-gray-700 mb-2">Proveedores con acceso a tu ubicación:</h4>
              <div id="sharedProvidersList" class="space-y-2">
                <!-- Shared providers will be listed here -->
              </div>
            </div>
          </div>

          <h3 class="text-lg font-medium text-gray-900 mb-3">Selecciona el tipo de servicio</h3>
          
          <!-- Servicios Técnicos -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-3">Servicios Técnicos</h3>
            <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
              <div class="job-icon bg-blue-50 text-blue-600 text-center" title="Plomero">
                <i class="fas fa-wrench text-2xl mb-2"></i>
                <p class="text-sm">Plomero</p>
              </div>
              <div class="job-icon bg-yellow-50 text-yellow-600 text-center" title="Electricista">
                <i class="fas fa-bolt text-2xl mb-2"></i>
                <p class="text-sm">Electricista</p>
              </div>
              <div class="job-icon bg-red-50 text-red-600 text-center" title="Electrodomésticos">
                <i class="fas fa-tv text-2xl mb-2"></i>
                <p class="text-sm">Electrodomésticos</p>
              </div>
              <div class="job-icon bg-green-50 text-green-600 text-center" title="Gasfiter">
                <i class="fas fa-fire text-2xl mb-2"></i>
                <p class="text-sm">Gasfiter</p>
              </div>
              <div class="job-icon bg-purple-50 text-purple-600 text-center" title="Aire Acondicionado">
                <i class="fas fa-snowflake text-2xl mb-2"></i>
                <p class="text-sm">Aire Acondicionado</p>
              </div>
              <div class="job-icon bg-indigo-50 text-indigo-600 text-center" title="Cerrajero">
                <i class="fas fa-key text-2xl mb-2"></i>
                <p class="text-sm">Cerrajero</p>
              </div>
              <div class="job-icon bg-pink-50 text-pink-600 text-center" title="Computadores/TV">
                <i class="fas fa-laptop text-2xl mb-2"></i>
                <p class="text-sm">Computadores/TV</p>
              </div>
            </div>
          </div>

          <!-- Limpieza y Orden -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-3">Limpieza y Orden</h3>
            <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
              <div class="job-icon bg-blue-50 text-blue-600 text-center" title="Limpieza Profunda">
                <i class="fas fa-broom text-2xl mb-2"></i>
                <p class="text-sm">Limpieza Profunda</p>
              </div>
              <div class="job-icon bg-green-50 text-green-600 text-center" title="Desinfección">
                <i class="fas fa-spray-can text-2xl mb-2"></i>
                <p class="text-sm">Desinfección</p>
              </div>
              <div class="job-icon bg-purple-50 text-purple-600 text-center" title="Organización">
                <i class="fas fa-box text-2xl mb-2"></i>
                <p class="text-sm">Organización</p>
              </div>
              <div class="job-icon bg-yellow-50 text-yellow-600 text-center" title="Lavado Alfombras">
                <i class="fas fa-soap text-2xl mb-2"></i>
                <p class="text-sm">Lavado Alfombras</p>
              </div>
              <div class="job-icon bg-indigo-50 text-indigo-600 text-center" title="Limpieza Vidrios">
                <i class="fas fa-window-maximize text-2xl mb-2"></i>
                <p class="text-sm">Limpieza Vidrios</p>
              </div>
            </div>
          </div>

          <!-- Estética y Cuidado Personal -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-3">Estética y Cuidado Personal</h3>
            <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
              <div class="job-icon bg-blue-50 text-blue-600 text-center" title="Peluquero">
                <i class="fas fa-cut text-2xl mb-2"></i>
                <p class="text-sm">Peluquero</p>
              </div>
              <div class="job-icon bg-pink-50 text-pink-600 text-center" title="Manicure/Pedicure">
                <i class="fas fa-hand-sparkles text-2xl mb-2"></i>
                <p class="text-sm">Manicure/Pedicure</p>
              </div>
              <div class="job-icon bg-purple-50 text-purple-600 text-center" title="Maquillaje">
                <i class="fas fa-paint-brush text-2xl mb-2"></i>
                <p class="text-sm">Maquillaje</p>
              </div>
              <div class="job-icon bg-green-50 text-green-600 text-center" title="Masajes">
                <i class="fas fa-spa text-2xl mb-2"></i>
                <p class="text-sm">Masajes</p>
              </div>
              <div class="job-icon bg-red-50 text-red-600 text-center" title="Depilación">
                <i class="fas fa-feather text-2xl mb-2"></i>
                <p class="text-sm">Depilación</p>
              </div>
              <div class="job-icon bg-yellow-50 text-yellow-600 text-center" title="Pestañas/Cejas">
                <i class="fas fa-eye text-2xl mb-2"></i>
                <p class="text-sm">Pestañas/Cejas</p>
              </div>
            </div>
          </div>

          <!-- Cuidado de Personas -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-3">Cuidado de Personas</h3>
            <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
              <div class="job-icon bg-pink-50 text-pink-600 text-center" title="Niñera">
                <i class="fas fa-baby text-2xl mb-2"></i>
                <p class="text-sm">Niñera</p>
              </div>
              <div class="job-icon bg-blue-50 text-blue-600 text-center" title="Cuidador Mayor">
                <i class="fas fa-user-nurse text-2xl mb-2"></i>
                <p class="text-sm">Cuidador Mayor</p>
              </div>
              <div class="job-icon bg-green-50 text-green-600 text-center" title="Terapeuta">
                <i class="fas fa-heartbeat text-2xl mb-2"></i>
                <p class="text-sm">Terapeuta</p>
              </div>
            </div>
          </div>

          <!-- Servicios para Mascotas -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-3">Servicios para Mascotas</h3>
            <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
              <div class="job-icon bg-blue-50 text-blue-600 text-center" title="Paseador">
                <i class="fas fa-dog text-2xl mb-2"></i>
                <p class="text-sm">Paseador</p>
              </div>
              <div class="job-icon bg-purple-50 text-purple-600 text-center" title="Peluquero Canino">
                <i class="fas fa-cut text-2xl mb-2"></i>
                <p class="text-sm">Peluquero Canino</p>
              </div>
              <div class="job-icon bg-green-50 text-green-600 text-center" title="Veterinario">
                <i class="fas fa-stethoscope text-2xl mb-2"></i>
                <p class="text-sm">Veterinario</p>
              </div>
            </div>
          </div>

          <!-- Servicios Gastronómicos -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-3">Servicios Gastronómicos</h3>
            <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
              <div class="job-icon bg-red-50 text-red-600 text-center" title="Chef">
                <i class="fas fa-utensils text-2xl mb-2"></i>
                <p class="text-sm">Chef</p>
              </div>
              <div class="job-icon bg-pink-50 text-pink-600 text-center" title="Catering">
                <i class="fas fa-birthday-cake text-2xl mb-2"></i>
                <p class="text-sm">Catering</p>
              </div>
            </div>
          </div>

          <!-- Otros Servicios -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-3">Otros Servicios</h3>
            <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
              <div class="job-icon bg-gray-50 text-gray-600 text-center" title="Otro Servicio">
                <i class="fas fa-plus-circle text-2xl mb-2"></i>
                <p class="text-sm">Otro Servicio</p>
              </div>
            </div>
          </div>

          <!-- Publicar Necesidad -->
          <div class="mb-6 bg-white rounded-lg shadow-sm p-4 border border-gray-200">
            <div class="flex items-start space-x-4">
              <div class="flex-shrink-0">
                <img id="userProfilePic" class="h-12 w-12 rounded-full object-cover cursor-pointer hover:opacity-80" 
                     src="https://ui-avatars.com/api/?name=User&background=0D8ABC&color=fff" 
                     alt="Profile Picture"
                     onclick="document.getElementById('profilePhotoInput').click()">
                <input type="file" id="profilePhotoInput" class="hidden" accept="image/*" onchange="updateProfilePhoto(event)">
              </div>
              <div class="flex-grow">
                <textarea id="needDescription" 
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                         placeholder="¿Qué servicio necesitas? Describe tu necesidad..."
                         rows="3"></textarea>
                <div class="mt-3 flex justify-between items-center">
                  <div class="flex space-x-2">
                    <button class="text-gray-500 hover:text-blue-600" onclick="attachPhoto()">
                      <i class="fas fa-camera"></i>
                    </button>
                    <button class="text-gray-500 hover:text-blue-600" onclick="attachLocation()">
                      <i class="fas fa-map-marker-alt"></i>
                    </button>
                  </div>
                  <button onclick="publishNeed()" 
                          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    Publicar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Feed de Necesidades -->
          <div id="needsFeed" class="space-y-4 mb-6">
            <!-- Las necesidades publicadas aparecerán aquí -->
          </div>

          <div class="relative">
              <input
                type="text"
                id="searchInput"
                placeholder="Buscar proveedores por nombre o servicio..."
                class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 pl-10 pr-4 py-3"
              />
              <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
          </div>

          <div id="providerList" class="space-y-4 mb-6">
            <!-- Provider cards will be generated here -->
          </div>
        </div>
      </section>

      <!-- Provider Details Slide-up Panel -->
      <div id="providerDetails" class="provider-details bg-white rounded-t-2xl shadow-lg p-6">
        <div class="max-w-4xl mx-auto">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="text-xl font-semibold text-gray-900" id="providerName"></h3>
              <p class="text-gray-600" id="providerJob"></p>
            </div>
            <button onclick="closeProviderDetails()" class="text-gray-500 hover:text-gray-700">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <div class="grid grid-cols-2 gap-6 mb-6">
            <div>
              <div class="flex items-center mb-2">
                <div class="review-stars text-lg mr-2" id="providerRating"></div>
                <span class="text-gray-600" id="providerReviewCount"></span>
              </div>
              <p class="text-2xl font-semibold text-blue-600 mb-2" id="providerPrice"></p>
              <p class="text-gray-600" id="providerLocation"></p>
            </div>
            <div>
              <h4 class="font-medium text-gray-900 mb-2">Horario de Atención</h4>
              <p class="text-gray-600">Lunes a Viernes: 9:00 - 18:00</p>
              <p class="text-gray-600">Sábados: 9:00 - 14:00</p>
            </div>
          </div>

          <div class="border-t border-gray-200 pt-6 mb-6">
            <h4 class="font-medium text-gray-900 mb-3">Servicios Ofrecidos</h4>
            <div class="grid grid-cols-2 gap-4" id="providerServices">
              <!-- Services will be populated here -->
            </div>
          </div>

          <div class="flex space-x-4">
            <button onclick="contactProvider()" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 flex items-center justify-center">
              <i class="fas fa-comment-alt mr-2"></i>
              Contactar
            </button>
            <button onclick="showDirections()" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition-colors duration-300 flex items-center justify-center">
              <i class="fas fa-directions mr-2"></i>
              Cómo Llegar
            </button>
          </div>
        </div>
      </div>

      <!-- Chat Modal -->
      <div id="chatModal" class="chat-modal">
        <div class="max-w-2xl w-full mx-auto my-8 bg-white rounded-xl shadow-2xl overflow-hidden">
          <div class="chat-container">
            <!-- Chat Header -->
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
              <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center">
                  <i class="fas fa-user text-blue-600"></i>
                </div>
                <div>
                  <h3 class="font-semibold" id="chatProviderName">Nombre del Proveedor</h3>
                  <p class="text-sm text-blue-100" id="chatProviderJob">Servicio</p>
                </div>
              </div>
              <div class="flex items-center space-x-4">
                <a href="#" id="whatsappLink" target="_blank" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors duration-200">
                  <i class="fab fa-whatsapp text-xl"></i>
                  <span>WhatsApp</span>
                </a>
                <button onclick="closeChatModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
              <!-- Messages will be added here -->
            </div>

            <!-- Chat Input -->
            <div class="border-t border-gray-200 p-4 bg-white">
              <form id="chatForm" class="flex space-x-4">
                <input type="text" id="messageInput" 
                       class="flex-1 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Escribe tu mensaje...">
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center space-x-2">
                  <i class="fas fa-paper-plane"></i>
                  <span>Enviar</span>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    // Función para actualizar la foto de perfil
    function updateProfilePhoto(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          // Actualizar todas las instancias de la foto de perfil
          const userProfilePics = document.querySelectorAll('#userProfilePic, #navProfilePic');
          userProfilePics.forEach(pic => {
            pic.src = e.target.result;
          });
          // Aquí se podría agregar la lógica para subir la foto al servidor
        };
        reader.readAsDataURL(file);
      }
    }

    // Función para adjuntar foto a la necesidad
    function attachPhoto() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          // Aquí se podría agregar la lógica para previsualizar y subir la foto
          alert('Foto adjuntada correctamente');
        }
      };
      input.click();
    }

    // Función para adjuntar ubicación
    function attachLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const { latitude, longitude } = position.coords;
          // Aquí se podría agregar la lógica para mostrar la ubicación en el mapa
          alert(`Ubicación capturada: ${latitude}, ${longitude}`);
        });
      }
    }

    // Función para publicar una necesidad
    function publishNeed() {
      const description = document.getElementById('needDescription').value;
      if (!description.trim()) {
        alert('Por favor describe tu necesidad');
        return;
      }

      const needsFeed = document.getElementById('needsFeed');
      const needElement = document.createElement('div');
      needElement.className = 'bg-white rounded-lg shadow-sm p-4 border border-gray-200 animate-fade-in';
      needElement.innerHTML = `
        <div class="flex items-start space-x-4">
          <img src="${document.getElementById('userProfilePic').src}" 
               class="h-10 w-10 rounded-full object-cover">
          <div class="flex-grow">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-medium text-gray-900">Usuario</h4>
                <p class="text-sm text-gray-500">Ahora mismo</p>
              </div>
              <div class="flex items-center space-x-2">
                <button class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-bell"></i>
                </button>
                <button class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
              </div>
            </div>
            <p class="mt-2 text-gray-700">${description}</p>
            <div class="mt-3 flex items-center space-x-4 text-sm text-gray-500">
              <button class="hover:text-blue-600 flex items-center space-x-1">
                <i class="far fa-comment"></i>
                <span>Responder</span>
              </button>
              <button class="hover:text-blue-600 flex items-center space-x-1">
                <i class="far fa-share-square"></i>
                <span>Compartir</span>
              </button>
              <button class="hover:text-red-600 flex items-center space-x-1">
                <i class="far fa-flag"></i>
                <span>Reportar</span>
              </button>
            </div>
          </div>
        </div>
      `;

      needsFeed.insertBefore(needElement, needsFeed.firstChild);
      document.getElementById('needDescription').value = '';
    }

    // Talca center coordinates
    const TALCA_CENTER = [-35.4264, -71.6553];
    
    let map, userMarker, providerMarkers = [];
    let selectedProvider = null;
    let userLocation = null;

    // Function to get and show user location
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = [position.coords.latitude, position.coords.longitude];
            
            // Remove existing user marker if any
            if (userMarker) {
              map.removeLayer(userMarker);
            }

            // Add user marker with custom icon
            userMarker = L.marker(userLocation, {
              icon: L.divIcon({
                className: 'user-marker',
                html: '<div class="w-8 h-8 bg-blue-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i class="fas fa-user text-white"></i></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
              })
            }).addTo(map);

            // Add popup to user marker
            userMarker.bindPopup('Tu ubicación actual').openPopup();

            // Center map on user location
            map.setView(userLocation, 14);

            // Update providers with distance from user
            updateProvidersDistance();
          },
          (error) => {
            console.error('Error getting location:', error);
            alert('No se pudo obtener tu ubicación. Por favor verifica los permisos de ubicación.');
          }
        );
      } else {
        alert('Tu navegador no soporta geolocalización');
      }
    }

    // Function to update providers with distance from user
    function updateProvidersDistance() {
      if (!userLocation) return;

      providers.forEach(provider => {
        const distance = calculateDistance(
          userLocation[0], userLocation[1],
          provider.lat, provider.lng
        );
        provider.distance = Math.round(distance * 10) / 10; // Round to 1 decimal
      });

      // Refresh provider list to show distances
      loadProviders();
    }

    // Calculate distance between two points in km
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Add location button to map
    function addLocationButton() {
      const locationButton = L.control({ position: 'topleft' });
      locationButton.onAdd = function() {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = `
          <button class="bg-white w-10 h-10 flex items-center justify-center rounded-lg shadow-lg hover:bg-gray-100 transition-colors" 
                  onclick="getUserLocation()" 
                  title="Mostrar mi ubicación">
            <i class="fas fa-location-arrow text-blue-600"></i>
          </button>
        `;
        return div;
      };
      locationButton.addTo(map);
    }

    // Providers data for Talca
    const providers = [
      {
        id: 1,
        name: "Juan Plomería Express",
        job: "Plomería",
        rating: 4.8,
        reviews: 156,
        price: "$15.000/hr",
        lat: -35.4264,
        lng: -71.6553,
        location: "Centro de Talca",
        phone: "56920277599", // Example phone number
        services: ["Reparación de cañerías", "Instalación de grifería", "Detección de fugas", "Desagües"],
        description: "Servicio profesional de plomería con más de 10 años de experiencia"
      },
      {
        id: 2,
        name: "Electricidad Moderna",
        job: "Electricista",
        rating: 4.9,
        reviews: 203,
        price: "$20.000/hr",
        lat: -35.4280,
        lng: -71.6570,
        location: "Sector Plaza de Armas",
        phone: "56920277598", // Example phone number
        services: ["Instalaciones eléctricas", "Reparaciones", "Certificaciones SEC", "Domótica"],
        description: "Electricistas certificados para todo tipo de instalaciones"
      },
      {
        id: 3,
        name: "Limpieza Total",
        job: "Limpieza",
        rating: 4.7,
        reviews: 89,
        lat: -35.4230,
        lng: -71.6520,
        location: "Sector Norte",
        phone: "56920277597", // Example phone number
        services: ["Limpieza de hogares", "Oficinas", "Tapicería", "Vidrios"],
        description: "Servicio profesional de limpieza para hogares y oficinas"
      }
    ];

    function initMap() {
      map = L.map('map').setView(TALCA_CENTER, 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);

      loadProviders();
    }

    function createProviderCard(provider) {
      const distanceHtml = provider.distance ? 
        `<span class="text-sm text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>${provider.distance} km</span>` : '';
      
      const isShared = sharedProviders.has(provider.id);
      const sharingBtnClass = isShared ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-500 hover:bg-gray-600';
      const sharingIcon = isShared ? 'fa-eye' : 'fa-eye-slash';
      const sharingText = isShared ? 'Ubicación compartida' : 'Compartir ubicación';

      return `
        <div class="provider-card bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                <i class="fas fa-user text-blue-600 text-xl"></i>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900">${provider.name}</h3>
                <div class="flex items-center space-x-2 text-sm">
                  <span class="text-yellow-500"><i class="fas fa-star"></i> ${provider.rating}</span>
                  <span class="text-gray-500">${provider.reviews} reseñas</span>
                </div>
              </div>
            </div>
            <div class="text-right">
              <p class="font-semibold text-blue-600">${provider.price}</p>
              <p class="text-sm text-gray-500">${provider.job}</p>
              ${distanceHtml}
            </div>
          </div>
        </div>
      `;
    }

    function loadProviders(filterJob = null, searchTerm = "") {
      providerMarkers.forEach(marker => map.removeLayer(marker));
      providerMarkers = [];
      providerList.innerHTML = "";

      const filteredProviders = providers.filter(p => {
        const matchesJob = filterJob ? p.job === filterJob : true;
        const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase());
        return matchesJob && matchesSearch;
      });

      filteredProviders.forEach(p => {
        const marker = L.marker([p.lat, p.lng])
          .addTo(map)
          .bindPopup(`
            <div class="text-center">
              <h3 class="font-semibold">${p.name}</h3>
              <p class="text-sm">${p.job}</p>
              <p class="text-sm text-yellow-500"><i class="fas fa-star"></i> ${p.rating}</p>
            </div>
          `);
        
        marker.on('click', () => showProviderDetails(p.id));
        providerMarkers.push(marker);

        const card = document.createElement('div');
        card.innerHTML = createProviderCard(p);
        providerList.appendChild(card);
      });
    }

    function showProviderDetails(providerId) {
      const provider = providers.find(p => p.id === providerId);
      if (!provider) return;

      selectedProvider = provider;
      
      // Update provider details panel
      document.getElementById('providerName').textContent = provider.name;
      document.getElementById('providerJob').textContent = provider.job;
      document.getElementById('providerPrice').textContent = provider.price;
      document.getElementById('providerLocation').textContent = provider.location;
      
      // Update rating stars
      const ratingHtml = Array(5).fill().map((_, i) => 
        `<i class="fas fa-star${i < Math.floor(provider.rating) ? '' : '-half-alt'}"></i>`
      ).join('');
      document.getElementById('providerRating').innerHTML = ratingHtml;
      document.getElementById('providerReviewCount').textContent = `(${provider.reviews} reseñas)`;

      // Update services
      const servicesHtml = provider.services.map(service => 
        `<div class="flex items-center space-x-2">
          <i class="fas fa-check text-green-500"></i>
          <span>${service}</span>
        </div>`
      ).join('');
      document.getElementById('providerServices').innerHTML = servicesHtml;

      // Show the panel
      document.getElementById('providerDetails').classList.add('show');

      // Center map on provider
      map.setView([provider.lat, provider.lng], 15);
    }

    function closeProviderDetails() {
      document.getElementById('providerDetails').classList.remove('show');
      selectedProvider = null;
      map.setView(TALCA_CENTER, 14);
    }

    function contactProvider() {
      if (!selectedProvider) return;
      
      // Update chat modal with provider info
      document.getElementById('chatProviderName').textContent = selectedProvider.name;
      document.getElementById('chatProviderJob').textContent = selectedProvider.job;
      
      // Update WhatsApp link
      document.getElementById('whatsappLink').href = `https://wa.me/${selectedProvider.phone}`;
      
      // Show welcome message
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = `
        <div class="message received">
          <p class="font-medium mb-1">${selectedProvider.name}</p>
          <p>¡Hola! ¿En qué puedo ayudarte?</p>
        </div>
      `;
      
      // Show chat modal
      document.getElementById('chatModal').classList.add('show');
    }

    function closeChatModal() {
      document.getElementById('chatModal').classList.remove('show');
    }

    // Handle chat form submission
    document.getElementById('chatForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      const chatMessages = document.getElementById('chatMessages');
      
      // Add user message
      chatMessages.innerHTML += `
        <div class="message sent">
          <p>${message}</p>
        </div>
      `;
      
      // Clear input
      input.value = '';
      
      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // Simulate provider response after 1 second
      setTimeout(() => {
        chatMessages.innerHTML += `
          <div class="message received">
            <p class="font-medium mb-1">${selectedProvider.name}</p>
            <p>Gracias por tu mensaje. Te responderé lo antes posible. También puedes contactarme por WhatsApp para una respuesta más rápida.</p>
          </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 1000);
    });

    function showDirections() {
      if (!selectedProvider) return;
      const url = `https://www.google.com/maps/dir/?api=1&destination=${selectedProvider.lat},${selectedProvider.lng}`;
      window.open(url, '_blank');
    }

    // Event Listeners
    document.querySelectorAll('.job-icon').forEach(icon => {
      icon.addEventListener('click', () => {
        const job = icon.title;
        document.querySelectorAll('.job-icon').forEach(i => i.classList.remove('selected', 'ring-2', 'ring-blue-500'));
        if (selectedProvider?.job !== job) {
          icon.classList.add('selected', 'ring-2', 'ring-blue-500');
          loadProviders(job, searchInput.value);
        } else {
          loadProviders(null, searchInput.value);
        }
      });
    });

    searchInput.addEventListener('input', () => {
      const selectedIcon = document.querySelector('.job-icon.selected');
      const job = selectedIcon ? selectedIcon.title : null;
      loadProviders(job, searchInput.value);
    });

    // Location sharing functionality
    let currentUserId = null; // Will be set after authentication
    let globalLocationSharing = false;
    let sharedProviders = new Set();

    async function toggleGlobalLocationSharing() {
      const toggle = document.getElementById('locationSharingToggle');
      const container = document.getElementById('sharedProvidersContainer');
      globalLocationSharing = toggle.checked;
      
      if (globalLocationSharing) {
        container.classList.remove('hidden');
        getUserLocation(); // Request location when sharing is enabled
      } else {
        container.classList.add('hidden');
        if (userMarker) {
          map.removeLayer(userMarker);
          userMarker = null;
        }
      }
    }

    async function toggleProviderLocationSharing(providerId) {
      if (!currentUserId) {
        alert('Por favor inicia sesión para compartir tu ubicación');
        return;
      }

      try {
        const response = await fetch('/location-sharing/toggle', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user_id: currentUserId,
            provider_id: providerId,
            is_shared: !sharedProviders.has(providerId)
          })
        });

        const data = await response.json();
        if (data.success) {
          if (data.is_shared) {
            sharedProviders.add(providerId);
          } else {
            sharedProviders.delete(providerId);
          }
          updateSharedProvidersList();
        }
      } catch (error) {
        console.error('Error toggling location sharing:', error);
        alert('Error al actualizar las preferencias de ubicación');
      }
    }

    function updateSharedProvidersList() {
      const container = document.getElementById('sharedProvidersList');
      container.innerHTML = '';

      providers.forEach(provider => {
        if (sharedProviders.has(provider.id)) {
          const providerElement = document.createElement('div');
          providerElement.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg';
          providerElement.innerHTML = `
            <div class="flex items-center space-x-2">
              <i class="fas fa-user-circle text-gray-600"></i>
              <span class="font-medium">${provider.name}</span>
            </div>
            <button onclick="toggleProviderLocationSharing(${provider.id})" 
                    class="text-red-600 hover:text-red-800">
              <i class="fas fa-times"></i>
            </button>
          `;
          container.appendChild(providerElement);
        }
      });

      if (container.children.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">No has compartido tu ubicación con ningún proveedor</p>';
      }
    }

    // Update getUserLocation function to consider sharing preferences
    function getUserLocation() {
      if (!globalLocationSharing) {
        return;
      }

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = [position.coords.latitude, position.coords.longitude];
            
            if (userMarker) {
              map.removeLayer(userMarker);
            }

            userMarker = L.marker(userLocation, {
              icon: L.divIcon({
                className: 'user-marker',
                html: '<div class="w-8 h-8 bg-blue-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i class="fas fa-user text-white"></i></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
              })
            }).addTo(map);

            userMarker.bindPopup('Tu ubicación actual').openPopup();
            map.setView(userLocation, 14);
            updateProvidersDistance();
          },
          (error) => {
            console.error('Error getting location:', error);
            alert('No se pudo obtener tu ubicación. Por favor verifica los permisos de ubicación.');
          }
        );
      } else {
        alert('Tu navegador no soporta geolocalización');
      }
    }

    // Initialize map and user menu on page load
    window.onload = () => {
      initMap();
      initUserMenu();
      // Check for existing location sharing preferences
      if (currentUserId) {
        fetch(`/location-sharing/shared-with/${currentUserId}`)
          .then(response => response.json())
          .then(data => {
            data.forEach(provider => sharedProviders.add(provider.id));
            updateSharedProvidersList();
          })
          .catch(console.error);
      }
    };

    // User menu functionality
    function initUserMenu() {
      const menuButton = document.getElementById('userMenuButton');
      const menu = document.getElementById('userMenu');
      const logoutLink = document.querySelector('a[href="/auth/logout"]');

      // Toggle menu on button click
      menuButton.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.classList.toggle('hidden');
      });

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!document.getElementById('userMenuContainer').contains(e.target)) {
          menu.classList.add('hidden');
        }
      });

      // Handle logout
      logoutLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (confirm('¿Estás seguro que deseas cerrar sesión?')) {
          // Aquí se podría agregar la lógica para cerrar sesión
          window.location.href = '/auth/logout';
        }
      });
    }
  </script>
</body>
</html>
